<app-barra-navegacion-veterinario></app-barra-navegacion-veterinario>

<section class="fondo-historial-mascotas">
    <h2 class="titulo-historial">Historial de mascotas</h2>

    <label for="exampleDataList" class="form-label label-historial">
        Ingrese nombre de la mascota:
    </label>

    <input class="form-control input-historial" [(ngModel)]="terminoBusqueda" id="exampleDataList"
        placeholder="Escriba para Buscar...">

    <section class="fondo-lista-usuarios">
        <table class="custom-table">
            <thead>
                <tr>
                    <th class="col-nombre">Dueño</th>
                    <th class="col-nombreMascota">Nombre de la Mascota</th>
                    <th class="col-generoMascota">Género</th>
                    <th class="col-acciones">Acciones</th>
                </tr>
            </thead>

            <tbody>
                @for (mascota of mascotasFiltradas; track $index) {
                <tr>
                    <td class="col-nombre">{{ mascota.nombrePaciente }} {{ mascota.apellidoPaciente }}</td>
                    <th class="col-nombreMascota">{{ mascota.nombreMascota }}</th>
                    <th class="col-generoMascota">{{ mascota.sexoMascota }}</th>
                    <td class="col-acciones">
                        <button class="btn-action btn-edit" (click)="verHistorial($index)">
                            Ver Historial Clínico
                        </button>
                    </td>
                </tr>
                }
            </tbody>
        </table>
    </section>
</section>

<!-- ========== MODAL: VER HISTORIAL CLÍNICO ========== -->
<div class="modal-overlay" *ngIf="mostrarModalHistorial" (click)="cerrarModalHistorial()">
    <div class="modal-content modal-large" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>
                <i class="fa-solid fa-book-medical"></i>
                Historial Clínico - {{ mascotaSeleccionada?.nombreMascota }}
            </h2>
            <button class="btn-close" (click)="cerrarModalHistorial()">&times;</button>
        </div>

        <div class="modal-body">
            <!-- Información de la mascota -->
            <div class="info-mascota">
                <p><strong>Dueño:</strong> {{ mascotaSeleccionada?.nombrePaciente }} {{ mascotaSeleccionada?.apellidoPaciente }}</p>
                <p><strong>Mascota:</strong> {{ mascotaSeleccionada?.nombreMascota }}</p>
                <p><strong>Tipo:</strong> {{ mascotaSeleccionada?.tipoMascota }}</p>
                <p><strong>Género:</strong> {{ mascotaSeleccionada?.sexoMascota }}</p>
                <p><strong>Edad:</strong> {{ mascotaSeleccionada?.edadMascota }} años</p>
            </div>

            <!-- Historial de Registros Clínicos (Múltiples) -->
            <div *ngIf="mascotaSeleccionada?.registrosClinicosHistorial && mascotaSeleccionada.registrosClinicosHistorial.length > 0">
                <h3 style="margin-top: 20px; margin-bottom: 15px; color: #17a2b8;">
                    <i class="fa-solid fa-history"></i> Historial de Consultas ({{ mascotaSeleccionada.registrosClinicosHistorial.length }})
                </h3>

                <!-- Iterar sobre cada registro clínico -->
                @for (registro of obtenerRegistrosOrdenados(); track $index) {
                <div class="registro-card" style="margin-bottom: 15px;">
                    <div class="registro-header">
                        <h3>
                            <i class="fa-solid fa-calendar"></i>
                            Consulta: {{ registro.fechaConsulta | date: 'dd/MM/yyyy' }}
                            @if ($index === 0) {
                                <span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 10px;">Más Reciente</span>
                            }
                        </h3>
                    </div>

                    <div class="registro-body">
                        <div class="registro-seccion">
                            <strong>Motivo de Consulta:</strong> {{ registro.motivoConsulta }}
                        </div>
                        <div class="registro-seccion">
                            <strong>Síntomas:</strong> {{ registro.sintomas }}
                        </div>

                        <div class="registro-row">
                            <div><strong>Peso:</strong> {{ registro.peso }} kg</div>
                            <div><strong>Temperatura:</strong> {{ registro.temperatura }}°C</div>
                            <div><strong>FC:</strong> {{ registro.frecuenciaCardiaca }} lpm</div>
                            <div><strong>FR:</strong> {{ registro.frecuenciaRespiratoria }} rpm</div>
                            <div><strong>Condición:</strong> {{ obtenerNombreCondicion(registro.condicionCorporal) }}</div>
                        </div>

                        <div class="registro-seccion">
                            <strong>Diagnóstico:</strong> {{ registro.diagnostico }}
                        </div>
                        <div class="registro-seccion">
                            <strong>Tratamiento:</strong> {{ registro.tratamiento }}
                        </div>
                        <div class="registro-seccion" *ngIf="registro.procedimientos">
                            <strong>Procedimientos:</strong> {{ registro.procedimientos }}
                        </div>
                        <div class="registro-seccion" *ngIf="registro.proximaCita">
                            <strong>Próxima Cita:</strong> {{ registro.proximaCita | date: 'dd/MM/yyyy' }}
                        </div>

                        <div class="registro-seccion" *ngIf="registro.tipoVacuna">
                            <strong>Vacuna Aplicada:</strong> {{ registro.tipoVacuna }}
                            <span *ngIf="registro.fechaVacuna">
                                - {{ registro.fechaVacuna | date: 'dd/MM/yyyy' }}
                            </span>
                        </div>
                        <div class="registro-seccion" *ngIf="registro.proximaDosis">
                            <strong>Próxima Dosis:</strong> {{ registro.proximaDosis | date: 'dd/MM/yyyy' }}
                        </div>
                    </div>

                    <!-- Solo permitir editar el último registro -->
                    @if ($index === 0) {
                    <div class="modal-footer">
                        <button class="btn-action btn-edit" (click)="abrirEditarRegistro($index)">
                            <i class="fa-solid fa-edit"></i> Editar Registro
                        </button>
                    </div>
                    }
                </div>
                }
            </div>

            <div class="sin-registros" *ngIf="!mascotaSeleccionada?.registrosClinicosHistorial || mascotaSeleccionada.registrosClinicosHistorial.length === 0">
                <i class="fa-solid fa-clipboard-question"></i>
                <p>No hay registros clínicos para esta mascota</p>
            </div>
        </div>
    </div>
</div>

<!-- ========== MODAL: EDITAR REGISTRO CLÍNICO ========== -->
<div class="modal-overlay" *ngIf="mostrarModalEditarRegistro" (click)="cerrarModalEditarRegistro()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2><i class="fa-solid fa-edit"></i> Editar Registro Clínico</h2>
            <button class="btn-close" (click)="cerrarModalEditarRegistro()">&times;</button>
        </div>

        <form class="modal-body">
            <!-- Información Básica -->
            <div class="seccion">
                <h3><i class="fa-solid fa-file-medical"></i> Información Básica</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha de Consulta</label>
                        <input type="date" [(ngModel)]="registroClinico.fechaConsulta" name="fechaConsulta" [min]="fechaMinima" (change)="validarFechaDomingo($event, 'fechaConsulta')" required>
                    </div>
                    <div class="form-group">
                        <label>Motivo de Consulta</label>
                        <input type="text" [(ngModel)]="registroClinico.motivoConsulta" name="motivoConsulta2"
                            placeholder="¿Por qué vino la mascota?" (input)="filtrarTexto($event)">
                    </div>
                </div>
                <div class="form-group">
                    <label>Síntomas Observados</label>
                    <textarea [(ngModel)]="registroClinico.sintomas" name="sintomas2" rows="3"
                        placeholder="Describe los síntomas..." (input)="filtrarTexto($event)"></textarea>
                </div>
            </div>

            <!-- Examen Físico -->
            <div class="seccion">
                <h3><i class="fa-solid fa-stethoscope"></i> Examen Físico</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Peso (kg)</label>
                        <input type="number" [(ngModel)]="registroClinico.peso" name="peso2" step="0.1"
                            placeholder="0.0" min="0" (keypress)="validarNumero($event)">
                    </div>
                    <div class="form-group">
                        <label>Temperatura (°C)</label>
                        <input type="number" [(ngModel)]="registroClinico.temperatura" name="temperatura2" step="0.1"
                            placeholder="0.0" min="0" (keypress)="validarNumero($event)">
                    </div>
                    <div class="form-group">
                        <label>Frecuencia Cardíaca (bpm)</label>
                        <input type="number" [(ngModel)]="registroClinico.frecuenciaCardiaca" name="frecuenciaCardiaca2"
                            placeholder="0" min="0" (keypress)="validarNumero($event)">
                    </div>
                    <div class="form-group">
                        <label>Frecuencia Respiratoria (rpm)</label>
                        <input type="number" [(ngModel)]="registroClinico.frecuenciaRespiratoria"
                            name="frecuenciaRespiratoria2" placeholder="0" min="0" (keypress)="validarNumero($event)">
                    </div>
                </div>
                <div class="form-group">
                    <label>Condición Corporal (1-5)</label>
                    <select [(ngModel)]="registroClinico.condicionCorporal" name="condicionCorporal2">
                        <option value="">Seleccione...</option>
                        <option value="1">1 - Muy delgado</option>
                        <option value="2">2 - Delgado</option>
                        <option value="3">3 - Ideal</option>
                        <option value="4">4 - Sobrepeso</option>
                        <option value="5">5 - Obeso</option>
                    </select>
                </div>
            </div>

            <!-- Diagnóstico y Tratamiento -->
            <div class="seccion">
                <h3><i class="fa-solid fa-notes-medical"></i> Diagnóstico y Tratamiento</h3>
                <div class="form-group">
                    <label>Diagnóstico</label>
                    <textarea [(ngModel)]="registroClinico.diagnostico" name="diagnostico2" rows="3"
                        placeholder="Diagnóstico del veterinario..." (input)="filtrarTexto($event)"></textarea>
                </div>
                <div class="form-group">
                    <label>Tratamiento</label>
                    <textarea [(ngModel)]="registroClinico.tratamiento" name="tratamiento2" rows="3"
                        placeholder="Medicamentos, dosis, duración..." (input)="filtrarTexto($event)"></textarea>
                </div>
                <div class="form-group">
                    <label>Procedimientos Realizados</label>
                    <input type="text" [(ngModel)]="registroClinico.procedimientos" name="procedimientos2"
                        placeholder="Ej: Vacunación, limpieza dental, etc." (input)="filtrarTexto($event)">
                </div>
                <div class="form-group">
                    <label>Próxima Cita</label>
                    <input type="date" [(ngModel)]="registroClinico.proximaCita" name="proximaCita2" [min]="fechaMinima" (change)="validarFechaDomingo($event, 'proximaCita')">
                </div>
            </div>

            <!-- Vacunación -->
            <div class="seccion">
                <h3><i class="fa-solid fa-syringe"></i> Vacunación</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tipo de Vacuna</label>
                        <input type="text" [(ngModel)]="registroClinico.tipoVacuna" name="tipoVacuna2"
                            placeholder="Ej: Rabia, Parvovirus..." (input)="filtrarTexto($event)">
                    </div>
                    <div class="form-group">
                        <label>Fecha de Vacuna</label>
                        <input type="date" [(ngModel)]="registroClinico.fechaVacuna" name="fechaVacuna2" [min]="fechaMinima">
                    </div>
                    <div class="form-group">
                        <label>Próxima Dosis</label>
                        <input type="date" [(ngModel)]="registroClinico.proximaDosis" name="proximaDosis2" [min]="fechaMinima">
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-cancelar" (click)="cerrarModalEditarRegistro()">Cancelar</button>
                <button type="button" class="btn-guardar" (click)="guardarEdicionRegistro()">Actualizar
                    Registro</button>
            </div>
        </form>
    </div>
</div>